# Claude Code Plan Mode Hooks Integration

This document explains how to configure Claude Code to automatically capture accepted plans and store them in Baton.

## Overview

When Claude Code's plan mode is used, accepted plans can be automatically captured and stored in Baton's database using Claude Code's hook system. This creates a permanent record of all AI-generated plans for your project.

## Prerequisites

1. **Baton Backend Running**: Ensure the Baton backend is running on `http://localhost:3001`
2. **Project Context**: Your workspace should have a `.baton-project` file in the root directory
3. **Claude Code**: You need Claude Code installed and configured

## Configuration Steps

### 1. Configure Claude Code Hook

In your Claude Code settings (`.claude/settings.toml`), add the following hook configuration:

```toml
[hooks.post_tool_use.ExitPlanMode]
command = "/path/to/your/baton/scripts/capture-plan.js"
```

Or using the Claude Code CLI:

```bash
claude config hooks add post-tool-use ExitPlanMode "/path/to/your/baton/scripts/capture-plan.js"
```

### 2. Verify Hook Script Permissions

Make sure the hook script is executable:

```bash
chmod +x /path/to/your/baton/scripts/capture-plan.js
```

### 3. Configure Environment (Optional)

The hook script supports the following environment variables:

- `BATON_API_URL`: Baton backend URL (default: `http://localhost:3001`)
- `DEBUG_PLAN_CAPTURE`: Set to `true` to enable debug logging

Example:
```bash
export BATON_API_URL="http://localhost:3001"
export DEBUG_PLAN_CAPTURE="true"
```

## How It Works

1. **Plan Creation**: When you use Claude Code's plan mode, Claude presents a plan for approval
2. **Plan Acceptance**: When you accept the plan, Claude calls the `ExitPlanMode` tool
3. **Hook Trigger**: The PostToolUse hook triggers after `ExitPlanMode` is called
4. **Data Capture**: The hook script extracts the plan content and metadata
5. **API Call**: The script sends the plan data to Baton's `/api/plans/capture` endpoint
6. **Storage**: The plan is stored in the database with project context
7. **Real-time Update**: WebSocket events notify the frontend for immediate display

## Data Captured

The following information is captured for each plan:

- **Plan Content**: The full markdown plan generated by Claude
- **Project Context**: Automatically linked to your current Baton project
- **Session Information**: Claude Code session ID for traceability
- **Metadata**: Workspace path, transcript location, and capture timestamp
- **Status**: Initially set to "accepted", can be updated to "implemented" or "archived"

## Viewing Captured Plans

Plans are automatically visible in the Baton frontend:

1. Open Baton in your browser (`http://localhost:5173`)
2. Navigate to your project
3. View the "Claude Code Plans" section in the right sidebar
4. Plans appear in real-time as they're captured

## Troubleshooting

### Hook Not Working

1. **Check Hook Configuration**:
   ```bash
   claude config hooks list
   ```

2. **Verify Script Path**: Ensure the path in your hook configuration is absolute and correct

3. **Check Permissions**: Ensure the script is executable:
   ```bash
   ls -la /path/to/baton/scripts/capture-plan.js
   ```

4. **Test Manually**: You can test the script manually:
   ```bash
   echo '{"tool_name": "ExitPlanMode", "tool_input": {"plan": "Test plan"}, "session_id": "test", "cwd": "/your/workspace"}' | /path/to/baton/scripts/capture-plan.js
   ```

### Plans Not Appearing

1. **Check Project Context**: Ensure your workspace has a `.baton-project` file:
   ```bash
   cat .baton-project
   ```

2. **Verify Project ID**: The project ID in `.baton-project` must exist in Baton's database

3. **Check API Connection**: Ensure Baton backend is running and accessible:
   ```bash
   curl http://localhost:3001/health
   ```

4. **Enable Debug Mode**: Set `DEBUG_PLAN_CAPTURE=true` to see detailed logging

### API Errors

- **404 Project Not Found**: Update the `projectId` in your `.baton-project` file
- **Connection Refused**: Ensure Baton backend is running on the correct port
- **Permission Denied**: Check that the hook script has execute permissions

## Example Plan Capture

When you accept a plan in Claude Code, it will automatically appear in Baton with:

```
Title: Plan captured on 2025-08-04T20:40:13.858Z
Content: [Your full plan content in markdown]
Status: accepted
Project: [Your current project]
Session: [Claude Code session ID]
```

## Integration Benefits

- **Permanent Storage**: Plans persist beyond Claude Code sessions
- **Team Visibility**: All team members can see captured plans
- **Project Context**: Plans are automatically linked to the correct project
- **Status Tracking**: Mark plans as implemented or archived
- **Real-time Updates**: Plans appear immediately in the UI
- **Searchable History**: Build a searchable archive of all AI-generated plans

## Next Steps

After plans are captured, you can:

1. **Review Plans**: Use the Baton UI to review all captured plans
2. **Update Status**: Mark plans as "implemented" or "archived" as work progresses
3. **Convert to Tasks**: Manually create tasks based on plan content
4. **Track Progress**: Use plans as a reference for project progress

For more information about Baton's MCP integration, see [MCP_INTEGRATION.md](./MCP_INTEGRATION.md).